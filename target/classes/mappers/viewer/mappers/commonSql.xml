<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="commonData">

	
	<select id="countThissens" parameterType="hashMap" resultType="int">
		select count(*) from tb_obs_tsen where law_code like
		concat(#{law_code},'%')
	</select>
	<select id="lookingLawArea" parameterType="hashMap" resultType="string">
		select law_area from tb_obs_tsen
		where law_code like concat(#{law_code},'%')
		limit 1
	</select>
	<select id="totalDamageByPeriod" parameterType="hashMap"
		resultType="yearDmeDto">
		select
		com_dme,
		(com_total+pub_total+pri_total) total_damage
		from (

		select
		( sum(com_1::numeric) + sum(com_2::numeric) ) com_dme
		,(
		sum( cob_tot::numeric)
		+sum(cos_tot::numeric)
		+sum(cof_tot::numeric)
		+sum(cow_tot::numeric)
		) com_total
		,(
		sum(pba_tot::numeric)
		+sum(pbb_tot::numeric)
		+sum(pbr_tot::numeric)
		+sum(pbc_tot::numeric)
		+sum(pbd_tot::numeric)
		+sum(pbf_tot::numeric)
		+sum(pbg_tot::numeric)
		+sum(pbh_tot::numeric)
		+sum(pbi_tot::numeric)
		+sum(pbj_tot::numeric)
		+sum(pbk_tot::numeric)
		+sum(pbl_tot::numeric)
		+sum(pbm_tot::numeric)
		+sum(pbn_tot::numeric)
		+sum(pbo_tot::numeric)
		) pub_total
		,(
		sum(pra_tot::numeric)
		+sum(prb_tot::numeric)
		+sum(prc_tot::numeric)
		+sum(prd_tot::numeric)
		+sum(pre_tot::numeric)
		+sum(prf_tot::numeric)
		+sum(prg_tot::numeric)
		+sum(etc_tot::numeric)
		) pri_total
		from
		tb_year_dme
		where
		sigungu_code like concat(#{law_code},'%')
		and
		concat(beg_year,beg_month,beg_day)<![CDATA[>=]]>#{beg_date}
		and concat(beg_year,beg_month,beg_day)<![CDATA[<=]]>#{end_date}
		<if test="damage_code">
			and damage_code=#{damage_code}
		</if>
		<if test="damage_info != null">
		and damage_info like concat('%',#{damage_info}, '%')
		</if>
		<if test="damage_codes!=null">
			and damage_code in
			<foreach collection="damage_codes" item="item" open="("
				close=")" separator=",">
				#{item}
			</foreach>
		</if>
		group by sigungu_code
		) t1
	</select>
	<select id="listDmeWithGungu" parameterType="hashMap"
		resultType="yearDmeDto">
		with main as(
		select law_code,stn_id,tm,rn_day,rn_10m_max,rn_60m_max from (
		select
		law_code
		, stn_id
		, tm
		, law_area_per::numeric * (case when rn_day is null then 0 else rn_day
		/ 10 end) rn_day
		, (case when rn_60m_max is null then 0 else rn_10m_max / 10 end)
		rn_10m_max
		, (case when rn_60m_max is null then 0 else rn_60m_max / 10 end)
		rn_60m_max
		from tb_obs_tsen asos
		left outer join tb_obs_asos tsen on asos.obs_id =
		tsen.stn_id::character varying
		where law_area in ('N','A')
		and tm<![CDATA[>=]]>#{beg_date}
		and tm<![CDATA[<=]]>#{end_date}
		and
		law_code like concat(#{law_code},'%')
		and rn_day is not null
		) t1
		where rn_day<![CDATA[>]]>0
		<if test="stRainValue!=null">
			and rn_day<![CDATA[>]]>#{stRainValue}
			and rn_day<![CDATA[<=]]>#{endRainValue}
		</if>
		)

		select
		code sigungu_code,
		sido,
		sigungu,
		sum(com_dme::numeric) com_dme,
		sum(com_total) com_total,
		sum(pub_total) pub_total,
		sum(pri_total) pri_total,
		(sum(com_total)+sum(pub_total)+sum(pri_total)) total_damage,
		max(com_dme::numeric) com_dme_max,
		max(com_total::numeric + pub_total::numeric + pri_total::numeric) total_damage_max
		from (
		select
		t3.code,
		t3.sido,
		t3.sigungu,
		beg_date,
		end_date,
		(select trunc(sum(rn_day),0) from main where
		substring(law_code,1,5)=substring(code,1,5) and tm<![CDATA[>=]]>beg_date
		and tm<![CDATA[<=]]>end_date)
		rn_day,
		(select trunc(max(rn_60m_max),0) from main where
		substring(law_code,1,5)=substring(code,1,5) and tm<![CDATA[>=]]>beg_date
		and tm<![CDATA[<=]]>end_date)
		rn_60m_max,
		com_dme,
		com_total,
		pub_total,
		pri_total
		from
		(

		select
		sido_code
		,sigungu_code
		,concat(beg_year,beg_month,beg_day) beg_date
		,concat(end_year,end_month,end_day) end_date
		,( sum(com_1::numeric)
		+sum(com_2::numeric)) com_dme
		,(
		sum( cob_tot::numeric)
		+sum(cos_tot::numeric)
		+sum(cof_tot::numeric)
		+sum(cow_tot::numeric)
		)
		com_total
		,(
		sum(pba_tot::numeric)
		+sum(pbb_tot::numeric)
		+sum(pbr_tot::numeric)
		+sum(pbc_tot::numeric)
		+sum(pbd_tot::numeric)
		+sum(pbf_tot::numeric)
		+sum(pbg_tot::numeric)
		+sum(pbh_tot::numeric)
		+sum(pbi_tot::numeric)
		+sum(pbj_tot::numeric)
		+sum(pbk_tot::numeric)
		+sum(pbl_tot::numeric)
		+sum(pbm_tot::numeric)
		+sum(pbn_tot::numeric)
		+sum(pbo_tot::numeric)
		) pub_total
		,(
		sum(pra_tot::numeric)
		+sum(prb_tot::numeric)
		+sum(prc_tot::numeric)
		+sum(prd_tot::numeric)
		+sum(pre_tot::numeric)
		+sum(prf_tot::numeric)
		+sum(prg_tot::numeric)
		+sum(etc_tot::numeric)
		) pri_total
		from
		tb_year_dme t1

		where
		sido_code like concat(#{law_code},'%')
		and
		concat(beg_year,beg_month,beg_day)<![CDATA[>=]]>#{beg_date}
		and concat(beg_year,beg_month,beg_day)<![CDATA[<=]]>#{end_date}
		<if test="damage_code!=null">
			and damage_code=#{damage_code}
		</if>
		<if test="damage_info != null">
		and damage_info like concat('%',#{damage_info}, '%')
		</if>
		<if test="damage_codes!=null">
			and damage_code in
			<foreach collection="damage_codes" item="item" open="("
				close=")" separator=",">
				#{item}
			</foreach>
		</if>
		group by
		damage_code,sido_code,sigungu_code,beg_year,beg_month,beg_day,end_year,end_month,end_day,damage_info
		) t2
		left join tb_year_area_code t3 on t2.sigungu_code=t3.code
		where t3.code_level='2'
		) t4
		group by code,sido,sigungu


	</select>
	<select id="listDmeWithGunguByArea" parameterType="hashMap"	resultType="yearDmeDto">
		with main as(
			select
			sigungu_code law_code
			,beg_date
			,end_date
			,rn_day
			,rn_60m_max
			from (
				select
				sido_code
				,sigungu_code
				,beg_date
				,end_date
				,(
					select sum(rn_day) rn_day from (
						select law_code, law_area_per::numeric * (case when rn_day is null then 0 else rn_day / 10 end) rn_day
						from tb_obs_tsen asos
						left outer join tb_obs_asos tsen on asos.obs_id =tsen.stn_id::character varying
						where law_area in ('Y')
						and tm<![CDATA[>=]]>beg_date and tm<![CDATA[<=]]>end_date
						and law_code like concat(sido_code,'%')
			
					) t1
					group by law_code
		
				)rn_day
				,(
					select max(rn_60m_max) rn_60m_max from (
						select law_code,(case when rn_60m_max is null then 0 else rn_60m_max / 10 end) rn_60m_max
							from tb_obs_tsen asos
							left outer join tb_obs_asos tsen on asos.obs_id =tsen.stn_id::character varying
							where law_area in ('Y')
							and tm<![CDATA[>=]]>beg_date and tm<![CDATA[<=]]>end_date
							and law_code like concat(sido_code,'%')
				
						) t1
						group by law_code
				) rn_60m_max
				
				from (
					select
					t1.sido_code
					,t1.sigungu_code
					,concat(beg_year,beg_month,beg_day) beg_date
					,concat(end_year,end_month,end_day) end_date
					from tb_year_dme t1
					left join tb_year_area_code t3 on t1.sigungu_code=t3.code
					where t3.code_level='2'
					and
					sido_code like concat(#{law_code},'%')
					and
					concat(beg_year,beg_month,beg_day)<![CDATA[>=]]>#{beg_date}	and concat(beg_year,beg_month,beg_day)<![CDATA[<=]]>#{end_date}
					<if test="damage_code!=null">
						and damage_code=#{damage_code}
					</if>
					<if test="damage_codes!=null">
						and damage_code in
						<foreach collection="damage_codes" item="item" open="("
							close=")" separator=",">
							#{item}
						</foreach>
					</if>
			) t1
			) t2
			where
			rn_day<![CDATA[>]]>0
			<if test="stRainValue!=null">
				and	rn_day<![CDATA[>]]>#{stRainValue}	and rn_day<![CDATA[<=]]>#{endRainValue}
			</if>
		)
		select
		code sigungu_code,
		sido,
		sigungu,
		sum(com_dme::numeric) com_dme,
		sum(com_total) com_total,
		sum(pub_total) pub_total,
		sum(pri_total) pri_total,
		(sum(com_total)+sum(pub_total)+sum(pri_total)) total_damage,
		max(com_dme::numeric) com_dme_max,
		max(com_total::numeric + pub_total::numeric + pri_total::numeric) total_damage_max
		from (
		select
		t3.code,
		t3.sido,
		t3.sigungu,
		beg_date,
		end_date,
		 rn_day,
		 rn_60m_max,
		com_dme,
		com_total,
		pub_total,
		pri_total
		from
		(

		select

		sido_code
		,sigungu_code
		,max(main.rn_day) rn_day
		,max(main.rn_60m_max) rn_60m_max
		,concat(beg_year,beg_month,beg_day) beg_date
		,concat(end_year,end_month,end_day) end_date
		,(
		sum(com_1::numeric)
		+sum(com_2::numeric)
		) com_dme
		,(
		sum( cob_tot::numeric)
		+sum(cos_tot::numeric)
		+sum(cof_tot::numeric)
		+sum(cow_tot::numeric)
		) com_total
		,(
		sum(pba_tot::numeric)
		+sum(pbb_tot::numeric)
		+sum(pbr_tot::numeric)
		+sum(pbc_tot::numeric)
		+sum(pbd_tot::numeric)
		+sum(pbf_tot::numeric)
		+sum(pbg_tot::numeric)
		+sum(pbh_tot::numeric)
		+sum(pbi_tot::numeric)
		+sum(pbj_tot::numeric)
		+sum(pbk_tot::numeric)
		+sum(pbl_tot::numeric)
		+sum(pbm_tot::numeric)
		+sum(pbn_tot::numeric)
		+sum(pbo_tot::numeric)
		)
		pub_total
		,(
		sum(pra_tot::numeric)
		+sum(prb_tot::numeric)
		+sum(prc_tot::numeric)
		+sum(prd_tot::numeric)
		+sum(pre_tot::numeric)
		+sum(prf_tot::numeric)
		+sum(prg_tot::numeric)
		+sum(etc_tot::numeric)
		)
		pri_total
		from tb_year_dme t1
		inner join main on t1.sigungu_code=main.law_code and concat(beg_year,beg_month,beg_day)=main.beg_date

		where
		sido_code like concat(#{law_code},'%')
		and
		concat(beg_year,beg_month,beg_day)<![CDATA[>=]]>#{beg_date}
		and concat(beg_year,beg_month,beg_day)<![CDATA[<=]]>#{end_date}
		<if test="damage_code!=null">
			and damage_code=#{damage_code}
		</if>
		<if test="damage_info != null">
		and damage_info like concat('%',#{damage_info}, '%')
		</if>
		<if test="damage_codes!=null">
			and damage_code in
			<foreach collection="damage_codes" item="item" open="("
				close=")" separator=",">
				#{item}
			</foreach>
		</if>
		group by
		damage_code,sido_code,sigungu_code,beg_year,beg_month,beg_day,end_year,end_month,end_day

		) t2
		left join tb_year_area_code t3 on t2.sigungu_code=t3.code
		where t3.code_level='2'
		) t4

		group by code,sido,sigungu

	</select>

	<!-- 재해이력 -->

	<select id="listDmeHisWithGungu" parameterType="hashMap"
		resultType="yearDmeDto">

		select
		damage_code,
		dmeCode.code_name damage_name,
		t3.code sigungu_code,
		t3.sido,
		t3.sigungu,
		beg_date,
		end_date,
		damage_info,
		(
		select trunc(sum(rn_day),0)from (
		select
		law_area_per::numeric * (case when rn_day is null then 0 else rn_day / 10 end) rn_day
		from tb_obs_tsen asos
		left outer join tb_obs_asos tsen on asos.obs_id =
		tsen.stn_id::character varying
		where law_area in ('N','A')
		and tm<![CDATA[>=]]>beg_date
		and tm<![CDATA[<=]]>end_date
		and
		substring(law_code,1,5)=substring(t3.code,1,5)
		and rn_day is not null

		) t1

		) rn_day
		,(
		select trunc(max(rn_60m_max),0) from (
		select
		( case when rn_60m_max is null then 0 else rn_60m_max / 10 end)
		rn_60m_max
		from tb_obs_tsen asos
		left outer join tb_obs_asos tsen on asos.obs_id =
		tsen.stn_id::character varying
		where law_area in ('N','A')
		and tm<![CDATA[>=]]>beg_date
		and tm<![CDATA[<=]]>end_date
		and
		substring(law_code,1,5)=substring(t3.code,1,5)
		and rn_day is not null

		) t1

		) rn_60m_max,
		(
		select trunc(max(wd_ins),0) from (
		select
		( case when wd_ins is null then 0 else wd_ins / 10 end) wd_ins
		from tb_obs_tsen asos
		left outer join tb_obs_asos tsen on asos.obs_id =
		tsen.stn_id::character varying
		where law_area in ('N','A')
		and tm<![CDATA[>=]]>beg_date
		and tm<![CDATA[<=]]>end_date
		and
		substring(law_code,1,5)=substring(t3.code,1,5)


		) t1

		) wd_ins,
		com_dme,
		com_total,
		pub_total,
		pri_total,
		(com_total+pub_total+pri_total) total_damage
		from
		(
		select
		damage_code
		,damage_info
		,sido_code
		,sigungu_code
		,concat(beg_year,beg_month,beg_day) beg_date
		,concat(end_year,end_month,end_day) end_date
		,(
		sum(com_1::numeric)
		+sum(com_2::numeric)
		) com_dme
		,(
		sum( cob_tot::numeric)
		+sum(cos_tot::numeric)
		+sum(cof_tot::numeric)
		+sum(cow_tot::numeric)
		) com_total
		,(
		sum(pba_tot::numeric)
		+sum(pbb_tot::numeric)
		+sum(pbr_tot::numeric)
		+sum(pbc_tot::numeric)
		+sum(pbd_tot::numeric)
		+sum(pbf_tot::numeric)
		+sum(pbg_tot::numeric)
		+sum(pbh_tot::numeric)
		+sum(pbi_tot::numeric)
		+sum(pbj_tot::numeric)
		+sum(pbk_tot::numeric)
		+sum(pbl_tot::numeric)
		+sum(pbm_tot::numeric)
		+sum(pbn_tot::numeric)
		+sum(pbo_tot::numeric)
		)
		pub_total
		,(
		sum(pra_tot::numeric)
		+sum(prb_tot::numeric)
		+sum(prc_tot::numeric)
		+sum(prd_tot::numeric)
		+sum(pre_tot::numeric)
		+sum(prf_tot::numeric)
		+sum(prg_tot::numeric)
		+sum(etc_tot::numeric)
		)
		pri_total
		from tb_year_dme t1
		where
		sigungu_code like concat(#{law_code},'%')
		and
		concat(beg_year,beg_month,beg_day)<![CDATA[>=]]>#{beg_date}
		and concat(beg_year,beg_month,beg_day)<![CDATA[<=]]>#{end_date}
		<if test="damage_code!=null">
			and damage_code=#{damage_code}
		</if>
		<if test="damage_info != null">
		and damage_info like concat('%',#{damage_info}, '%')
		</if>
		<if test="damage_codes!=null">
			and damage_code in
			<foreach collection="damage_codes" item="item" open="("
				close=")" separator=",">
				#{item}
			</foreach>
		</if>
		group by
		damage_code,sido_code,sigungu_code,beg_year,beg_month,beg_day,end_year,end_month,end_day,damage_info
		) t2
		left join tb_year_area_code t3 on t2.sigungu_code=t3.code
		left join tb_year_dme_code dmeCode on t2.damage_code=dmeCode.code
		where t3.code_level='2'
		order by beg_date

	</select>
	<select id="listDmeHisWithGunguByArea" parameterType="hashMap"
		resultType="yearDmeDto">
		with main as(
		select law_code,stn_id,tm,rn_day,rn_10m_max,rn_60m_max,wd_ins from (
		select
		law_code
		, stn_id
		, tm
		, law_area_per::numeric * (case when rn_day is null then 0 else rn_day
		/ 10 end) rn_day
		,(case when rn_10m_max is null then 0 else rn_10m_max / 10 end) rn_10m_max
		,(case when rn_60m_max is null then 0 else rn_60m_max / 10 end)
		rn_60m_max
		,(case when wd_ins is null then 0 else wd_ins end) wd_ins
		from tb_obs_tsen asos
		left outer join tb_obs_asos tsen on asos.obs_id =
		tsen.stn_id::character varying
		where law_area in ('Y')
		and tm<![CDATA[>=]]>#{beg_date}
		and tm<![CDATA[<=]]>#{end_date}
		and
		law_code like concat(#{sido_code},'%')
		and rn_day is not null
		) t1

		)


		select
		damage_code,
		t2.damage_info,
		dmeCode.code_name damage_name,
		t3.code sigungu_code,
		t3.sido,
		t3.sigungu,
		beg_date,
		end_date,
		trunc((select trunc(sum(rn_day),0) from main where
		substring(law_code,1,2)=substring(t3.code,1,2) and tm<![CDATA[>=]]>beg_date
		and tm<![CDATA[<=]]>end_date),0)
		rn_day,
		trunc((select trunc(max(rn_60m_max),0) from main where
		substring(law_code,1,2)=substring(t3.code,1,2) and tm<![CDATA[>=]]>beg_date
		and tm<![CDATA[<=]]>end_date),0)
		rn_60m_max,
		(select trunc(max(wd_ins),0) from main where
		substring(law_code,1,2)=substring(t3.code,1,2) and tm<![CDATA[>=]]>beg_date
		and tm<![CDATA[<=]]>end_date)
		wd_ins,
		com_dme,
		com_total,
		pub_total,
		pri_total,
		(com_total+pub_total+pri_total) total_damage
		from
		(

		select
		damage_code
		,damage_info
		,(
		sum(com_1::numeric)
		+sum(com_2::numeric)
		) com_dme
		,sido_code
		,sigungu_code
		,concat(beg_year,beg_month,beg_day)
		beg_date
		,concat(end_year,end_month,end_day) end_date
		,(
		sum(
		cob_tot::numeric)
		+sum(cos_tot::numeric)
		+sum(cof_tot::numeric)
		+sum(cow_tot::numeric)
		) com_total
		,(
		sum(pba_tot::numeric)
		+sum(pbb_tot::numeric)
		+sum(pbr_tot::numeric)
		+sum(pbc_tot::numeric)
		+sum(pbd_tot::numeric)
		+sum(pbf_tot::numeric)
		+sum(pbg_tot::numeric)
		+sum(pbh_tot::numeric)
		+sum(pbi_tot::numeric)
		+sum(pbj_tot::numeric)
		+sum(pbk_tot::numeric)
		+sum(pbl_tot::numeric)
		+sum(pbm_tot::numeric)
		+sum(pbn_tot::numeric)
		+sum(pbo_tot::numeric)
		) pub_total
		,(
		sum(pra_tot::numeric)
		+sum(prb_tot::numeric)
		+sum(prc_tot::numeric)
		+sum(prd_tot::numeric)
		+sum(pre_tot::numeric)
		+sum(prf_tot::numeric)
		+sum(prg_tot::numeric)
		+sum(etc_tot::numeric)
		) pri_total
		from
		tb_year_dme t1
		where
		sigungu_code like concat(#{law_code},'%')
		and
		concat(beg_year,beg_month,beg_day)<![CDATA[>=]]>#{beg_date}
		and concat(beg_year,beg_month,beg_day)<![CDATA[<=]]>#{end_date}
		<if test="damage_info != null">
		and damage_info like concat('%',#{damage_info}, '%')
		</if>
		<if test="damage_code!=null">
			and damage_code=#{damage_code}
		</if>
		<if test="damage_codes!=null">
			and damage_code in
			<foreach collection="damage_codes" item="item" open="("
				close=")" separator=",">
				#{item}
			</foreach>
		</if>
		group by
		damage_code,sido_code,sigungu_code,beg_year,beg_month,beg_day,end_year,end_month,end_day,damage_info

		) t2
		left join tb_year_area_code t3 on t2.sigungu_code=t3.code
		left join tb_year_dme_code dmeCode on t2.damage_code=dmeCode.code
		where t3.code_level='2'
		order by beg_date

	</select>
	<select id="maxDamagePersonByYear" parameterType="hashMap"
		resultType="yearDmeDto">
		select beg_year, sum( com_1::numeric + com_2::numeric ) com_dme from
		tb_year_dme
		where
		sigungu_code like concat(#{law_code},'%')
		<if test="damage_code!=null">
			and damage_code=#{damage_code}
		</if>
		<if test="damage_info != null">
		and damage_info like concat('%',#{damage_info}, '%')
		</if>
		<if test="damage_codes!=null">
			and damage_code in
			<foreach collection="damage_codes" item="item" open="("
				close=")" separator=",">
				#{item}
			</foreach>
		</if>
		group by beg_year,sigungu_code
		order by com_dme desc
		limit 1
	</select>

	<select id="maxDamageMoneyByYear" parameterType="hashMap"
		resultType="yearDmeDto">
		select
		beg_year,com_dme,com_total,pub_total,pri_total,(com_total+pub_total+pri_total)
		total_damage from (
		select
		beg_year,
		(
		sum(com_1::numeric)
		+sum(com_2::numeric)
		) com_dme
		, (
		sum( cob_tot::numeric)
		+sum(cos_tot::numeric)
		+sum(cof_tot::numeric)
		+sum(cow_tot::numeric)
		) com_total
		,(
		sum(pba_tot::numeric)
		+sum(pbb_tot::numeric)
		+sum(pbr_tot::numeric)
		+sum(pbc_tot::numeric)
		+sum(pbd_tot::numeric)
		+sum(pbf_tot::numeric)
		+sum(pbg_tot::numeric)
		+sum(pbh_tot::numeric)
		+sum(pbi_tot::numeric)
		+sum(pbj_tot::numeric)
		+sum(pbk_tot::numeric)
		+sum(pbl_tot::numeric)
		+sum(pbm_tot::numeric)
		+sum(pbn_tot::numeric)
		+sum(pbo_tot::numeric)
		) pub_total
		,(
		sum(pra_tot::numeric)
		+sum(prb_tot::numeric)
		+sum(prc_tot::numeric)
		+sum(prd_tot::numeric)
		+sum(pre_tot::numeric)
		+sum(prf_tot::numeric)
		+sum(prg_tot::numeric)
		+sum(etc_tot::numeric)
		) pri_total
		from
		tb_year_dme
		where
		sigungu_code like concat(#{law_code},'%')
		<if test="damage_code!=null">
			and damage_code=#{damage_code}
		</if>
		<if test="damage_info != null">
		and damage_info like concat('%',#{damage_info}, '%')
		</if>
		<if test="damage_codes!=null">
			and damage_code in
			<foreach collection="damage_codes" item="item" open="("
				close=")" separator=",">
				#{item}
			</foreach>
		</if>
		group by beg_year,sigungu_code
		)t1
		order by total_damage desc
		limit 1
	</select>

	<select id="sumDamgePersonByGungu" parameterType="hashMap"
		resultType="yearDmeDto">
		select
		t3.code sigungu_code,
		t3.sido,
		t3.sigungu,
		com_dme,
		com_total,
		pub_total,
		pri_total,
		total_damage,
		com_dme_max,
		total_damage_max
		from
		(

		select
		sido
		, sigungu
		, sum(com_dme) com_dme
		, sum(com_total) com_total
		, sum(pub_total) pub_total
		, sum(pri_total) pri_total
		, sum(com_total+pub_total+pri_total) total_damage
		, max(com_dme) com_dme_max
		, max(com_total+pub_total+pri_total) total_damage_max
		from
		(

		select

		sido_code
		,sigungu_code
		,concat(beg_year,beg_month,beg_day)
		,(
		sum(com_1::numeric)
		+sum(com_2::numeric)
		) com_dme
		,(
		sum( cob_tot::numeric)
		+sum(cos_tot::numeric)
		+sum(cof_tot::numeric)
		+sum(cow_tot::numeric)
		) com_total
		,(
		sum(pba_tot::numeric)
		+sum(pbb_tot::numeric)
		+sum(pbr_tot::numeric)
		+sum(pbc_tot::numeric)
		+sum(pbd_tot::numeric)
		+sum(pbf_tot::numeric)
		+sum(pbg_tot::numeric)
		+sum(pbh_tot::numeric)
		+sum(pbi_tot::numeric)
		+sum(pbj_tot::numeric)
		+sum(pbk_tot::numeric)
		+sum(pbl_tot::numeric)
		+sum(pbm_tot::numeric)
		+sum(pbn_tot::numeric)
		+sum(pbo_tot::numeric)
		)
		pub_total
		,(
		sum(pra_tot::numeric)
		+sum(prb_tot::numeric)
		+sum(prc_tot::numeric)
		+sum(prd_tot::numeric)
		+sum(pre_tot::numeric)
		+sum(prf_tot::numeric)
		+sum(prg_tot::numeric)
		+sum(etc_tot::numeric)
		)
		pri_total
		from tb_year_dme t1
		where
		sigungu_code like concat(#{law_code},'%')
		and concat(beg_year,beg_month,beg_day)<![CDATA[>=]]>#{beg_date}
		and concat(beg_year,beg_month,beg_day)<![CDATA[<=]]>#{end_date}
		<if test="damage_code!=null">
			and damage_code=#{damage_code}
		</if>
		<if test="damage_info != null">
		and damage_info like concat('%',#{damage_info}, '%')
		</if>
		<if test="damage_codes!=null">
			and damage_code in
			<foreach collection="damage_codes" item="item" open="("
				close=")" separator=",">
				#{item}
			</foreach>
		</if>
		group by sido_code,sigungu_code, concat(beg_year,beg_month,beg_day)
		)
		rs

		) t2
		left join tb_year_area_code t3 on t2.sigungu_code=t3.code
		where t3.code_level='2'
		order by com_dme desc
		limit 1
	</select>


	<select id="sumDamageByGungu" parameterType="hashMap"
		resultType="yearDmeDto">
		with main as (
		select sido_code
		,damage_info
		,sigungu_code
		,beg_date
		,end_date
		,rn_day
		from (
		select
		sido_code
		,sigungu_code
		,beg_date
		,end_date
		,damage_info
		,(
		select sum(rn_day) rn_day from (
		select law_code, law_area_per::numeric * (case when rn_day is null then 0
		else rn_day / 10 end) rn_day
		from tb_obs_tsen asos
		left outer join tb_obs_asos tsen on asos.obs_id =
		tsen.stn_id::character varying
		where law_area in ('N','A')
		and tm<![CDATA[>=]]>beg_date
		and tm<![CDATA[<=]]>end_date
		and law_code like concat(sigungu_code,'%')

		) t1
		group by law_code

		)rn_day

		from (
		select
		sido_code
		,sigungu_code
		,damage_info
		, concat(beg_year,beg_month,beg_day) beg_date
		,concat(end_year,end_month,end_day) end_date
		from tb_year_dme
		where
		concat(beg_year,beg_month,beg_day)<![CDATA[>=]]>#{beg_date}
		and concat(beg_year,beg_month,beg_day)<![CDATA[<=]]>#{end_date}
		<if test="damage_info != null">
		and damage_info like concat('%',#{damage_info}, '%')
		</if>
		<if test="gunguCodes!=null">
			and sigungu_code in
			<foreach collection="gunguCodes" item="item" open="(" close=")"
				separator=",">
				#{item}
			</foreach>
		</if>
		<if test="damage_code!=null">
			and damage_code=#{damage_code}
		</if>
		<if test="damage_codes!=null">
			and damage_code in
			<foreach collection="damage_codes" item="item" open="("
				close=")" separator=",">
				#{item}
			</foreach>
		</if>
		) t1
		) t2
		<if test="stRainValue!=null">
			where rn_day<![CDATA[>]]>#{stRainValue}
			and rn_day<![CDATA[<=]]>#{endRainValue}
		</if>


		)


		select
		t3.code sigungu_code,
		t3.sido,
		t3.sigungu,
		com_dme,
		com_total,
		pub_total,
		pri_total,
		total_damage,
		com_dme_max,
		total_damage_max
		from
		(

		select
		sido_code
		, sigungu_code
		
		, sum(com_dme) com_dme
		, sum(com_total) com_total
		, sum(pub_total) pub_total
		, sum(pri_total) pri_total
		, sum(com_total+pub_total+pri_total) total_damage
		, max(com_dme) com_dme_max
		, max(com_total+pub_total+pri_total) total_damage_max
		from(



		select
		t1.sido_code
		, t1.sigungu_code
		
		, concat(beg_year, beg_month, beg_day) beg_date
		,( sum(com_1::numeric) + sum(com_2::numeric) ) com_dme
		,(sum(
		cob_tot::numeric)+sum(cos_tot::numeric)+sum(cof_tot::numeric)+sum(cow_tot::numeric))
		com_total
		,(
		sum(pba_tot::numeric)
		+sum(pbb_tot::numeric)
		+sum(pbr_tot::numeric)
		+sum(pbc_tot::numeric)
		+sum(pbd_tot::numeric)
		+sum(pbf_tot::numeric)
		+sum(pbg_tot::numeric)
		+sum(pbh_tot::numeric)
		+sum(pbi_tot::numeric)
		+sum(pbj_tot::numeric)
		+sum(pbk_tot::numeric)
		+sum(pbl_tot::numeric)
		+sum(pbm_tot::numeric)
		+sum(pbn_tot::numeric)
		+sum(pbo_tot::numeric)
		) pub_total
		,(
		sum(pra_tot::numeric)
		+sum(prb_tot::numeric)
		+sum(prc_tot::numeric)
		+sum(prd_tot::numeric)
		+sum(pre_tot::numeric)
		+sum(prf_tot::numeric)
		+sum(prg_tot::numeric)
		+sum(etc_tot::numeric)
		) pri_total
		, max(com_1::numeric + com_2::numeric) com_dme_max
		, max(
		cob_tot::numeric+cos_tot::numeric+cof_tot::numeric+cow_tot::numeric)
		com_total_max
		, max(pba_tot::numeric
		+pbb_tot::numeric
		+pbr_tot::numeric
		+pbc_tot::numeric
		+pbd_tot::numeric
		+pbf_tot::numeric
		+pbg_tot::numeric
		+pbh_tot::numeric
		+pbi_tot::numeric
		+pbj_tot::numeric
		+pbk_tot::numeric
		+pbl_tot::numeric
		+pbm_tot::numeric
		+pbn_tot::numeric
		+pbo_tot::numeric)
		pub_total_max, max(pra_tot::numeric
		+prb_tot::numeric
		+prc_tot::numeric
		+prd_tot::numeric
		+pre_tot::numeric
		+prf_tot::numeric
		+prg_tot::numeric
		+etc_tot::numeric) pri_total_max

		from tb_year_dme t1
		inner join main on t1.sigungu_code=main.sigungu_code and
		concat(t1.beg_year, t1.beg_month, t1.beg_day)=main.beg_date
		where
		concat(t1.beg_year,t1.beg_month,t1.beg_day)<![CDATA[>=]]>#{beg_date}
		and concat(t1.beg_year,t1.beg_month,t1.beg_day)<![CDATA[<=]]>#{end_date}
		<if test="damage_info != null">
		and damage_info like concat('%',#{damage_info}, '%')
		</if>
		<if test="gunguCodes!=null">
			and t1.sigungu_code in
			<foreach collection="gunguCodes" item="item" open="(" close=")"
				separator=",">
				#{item}
			</foreach>
		</if>
		<if test="damage_code!=null">
			and t1.damage_code=#{damage_code}
		</if>
		<if test="damage_codes!=null">
			and t1.damage_code in
			<foreach collection="damage_codes" item="item" open="("
				close=")" separator=",">
				#{item}
			</foreach>
		</if>


		group by t1.sido_code,t1.sigungu_code, concat(beg_year, beg_month,beg_day)
		) rs
		group by sido_code, sigungu_code
		) t2
		left join tb_year_area_code t3 on t2.sigungu_code=t3.code
		where t3.code_level='2'

	</select>

	<select id="listDamagePersonTop10" parameterType="hashMap"
		resultType="yearDmeDto">
		with main as
		(
		select
		sido_code
		,sigungu_code
		,com_dme
		,com_total
		,pub_total
		,pri_total
		,total_damage
		,com_dme_max
		,total_damage_max

		from (

		select
		sido_code
		, sigungu_code
		, sum(com_dme) com_dme
		, sum(com_total) com_total
		, sum(pub_total) pub_total
		, sum(pri_total) pri_total
		, sum(com_total+pub_total+pri_total) total_damage
		, max(com_dme) com_dme_max
		, max(com_total+pub_total+pri_total) total_damage_max
		from(
		select
		sido_code
		,sigungu_code
		,concat(beg_year,beg_month,beg_day)
		,(
		sum(com_1::numeric)
		+ sum(com_2::numeric)
		) com_dme
		,(
		sum( cob_tot::numeric)
		+sum(cos_tot::numeric)
		+sum(cof_tot::numeric)
		+sum(cow_tot::numeric)
		) com_total
		,(
		sum(pba_tot::numeric)
		+sum(pbb_tot::numeric)
		+sum(pbr_tot::numeric)
		+sum(pbc_tot::numeric)
		+sum(pbd_tot::numeric)
		+sum(pbf_tot::numeric)
		+sum(pbg_tot::numeric)
		+sum(pbh_tot::numeric)
		+sum(pbi_tot::numeric)
		+sum(pbj_tot::numeric)
		+sum(pbk_tot::numeric)
		+sum(pbl_tot::numeric)
		+sum(pbm_tot::numeric)
		+sum(pbn_tot::numeric)
		+sum(pbo_tot::numeric)
		)
		pub_total
		,(
		sum(pra_tot::numeric)
		+sum(prb_tot::numeric)
		+sum(prc_tot::numeric)
		+sum(prd_tot::numeric)
		+sum(pre_tot::numeric)
		+sum(prf_tot::numeric)
		+sum(prg_tot::numeric)
		+sum(etc_tot::numeric)
		)
		pri_total
		from tb_year_dme t1,tb_year_area_code t2
		where
		t1.sigungu_code=t2.code
		and
		t2.code_level='2'
		and concat(beg_year,beg_month,beg_day)<![CDATA[>=]]>#{beg_date}
		and concat(beg_year,beg_month,beg_day)<![CDATA[<=]]>#{end_date}
		<if test="damage_code!=null">
			and damage_code=#{damage_code}
		</if>
		<if test="damage_info != null">
		and damage_info like concat('%',#{damage_info}, '%')
		</if>
		<if test="damage_codes!=null">
			and damage_code in
			<foreach collection="damage_codes" item="item" open="("
				close=")" separator=",">
				#{item}
			</foreach>
		</if>
		<if test="law_code!=null">
			and sido_code.substring(1,2)=#{law_code}
		</if>
		group by sido_code,sigungu_code, concat(beg_year,beg_month,beg_day)

		) rs
		group by sido_code,sigungu_code
		) t4
		order by com_dme desc
		limit 10
		)
		select
		sido_code
		,sigungu_code
		,t5.sido
		,t5.sigungu
		,com_dme
		,com_total
		,pub_total
		,pri_total
		,total_damage
		,com_dme_max
		,total_damage_max
		from main
		left join tb_year_area_code t5 on main.sigungu_code=t5.code
		where t5.code_level = '2'
		order by com_dme desc
	</select>
	<select id="listDamageMoneyTop10" parameterType="hashMap" resultType="yearDmeDto">
		with main as
		(
		select
		sido_code
		,sigungu_code
		,com_dme
		,com_total
		,pub_total
		,pri_total
		,total_damage
		,com_dme_max
		,total_damage_max
		from (

		select
		sido_code
		, sigungu_code
		, sum(com_dme) com_dme
		, sum(com_total) com_total
		, sum(pub_total) pub_total
		, sum(pri_total) pri_total
		, sum(com_total+pub_total+pri_total) total_damage
		, max(com_dme) com_dme_max
		, max(com_total+pub_total+pri_total) total_damage_max
		from(
		select
		sido_code
		,sigungu_code
		, concat(beg_year,beg_month,beg_day)
		,(
		sum(com_1::numeric)
		+ sum(com_2::numeric)
		) com_dme
		,(
		sum( cob_tot::numeric)
		+sum(cos_tot::numeric)
		+sum(cof_tot::numeric)
		+sum(cow_tot::numeric)
		) com_total
		,(
		sum(pba_tot::numeric)
		+sum(pbb_tot::numeric)
		+sum(pbr_tot::numeric)
		+sum(pbc_tot::numeric)
		+sum(pbd_tot::numeric)
		+sum(pbf_tot::numeric)
		+sum(pbg_tot::numeric)
		+sum(pbh_tot::numeric)
		+sum(pbi_tot::numeric)
		+sum(pbj_tot::numeric)
		+sum(pbk_tot::numeric)
		+sum(pbl_tot::numeric)
		+sum(pbm_tot::numeric)
		+sum(pbn_tot::numeric)
		+sum(pbo_tot::numeric)
		)
		pub_total
		,(
		sum(pra_tot::numeric)
		+sum(prb_tot::numeric)
		+sum(prc_tot::numeric)
		+sum(prd_tot::numeric)
		+sum(pre_tot::numeric)
		+sum(prf_tot::numeric)
		+sum(prg_tot::numeric)
		+sum(etc_tot::numeric)
		)
		pri_total
		from tb_year_dme t1,tb_year_area_code t2
		where
		t1.sigungu_code=t2.code
		and
		t2.code_level='2'
		and concat(beg_year,beg_month,beg_day)<![CDATA[>=]]>#{beg_date}
		and concat(beg_year,beg_month,beg_day)<![CDATA[<=]]>#{end_date}
		<if test="damage_info != null">
		and damage_info like concat('%',#{damage_info}, '%')
		</if>
		<if test="damage_code!=null">
			and damage_code=#{damage_code}
		</if>
		<if test="damage_codes!=null">
			and damage_code in
			<foreach collection="damage_codes" item="item" open="("
				close=")" separator=",">
				#{item}
			</foreach>
		</if>
		<if test="law_code!=null">
			and sido_code.substring(1,2)=#{law_code}
		</if>
		group by sido_code,sigungu_code, concat(beg_year,beg_month,beg_day)
		) rs
		group by sido_code, sigungu_code
		) t4
		order by total_damage desc
		limit 10
		)
		select
		sido_code
		,sigungu_code
		,t5.sido
		,t5.sigungu
		,com_dme
		,com_total
		,pub_total
		,pri_total
		,total_damage
		,com_dme_max
		,total_damage_max
		from main
		left join tb_year_area_code t5 on main.sigungu_code=t5.code
		where t5.code_level = '2'
		order by total_damage desc
	</select>

	<select id="listGunguDmeCause" parameterType="hashMap"
		resultType="yearDmeDto">
		select
		concat(beg_year, beg_month, beg_day) beg_date
		, sigungu_code
		, inform_nm
		, damage_cause
		,
		damage_result
		, com_dme
		, gender
		, age_sperate
		from tb_year_dme_cause
		where sigungu_code is not null
		and concat(beg_year, beg_month, beg_day) <![CDATA[>=]]>
		#{beg_date} and concat(beg_year, beg_month, beg_day) <![CDATA[<=]]>
		#{end_date}
		<if test="law_code != null">
			and sigungu_code = #{law_code}
		</if>
		order by beg_date asc;
	</select>


	<select id="listGunguDmeCauseResultSum" parameterType="hashMap"
		resultType="yearDmeDto">
		select beg_date
		, sigungu_code
		, damage_cause
		, damage_result
		, sum(com_dme) com_dme
		from(
		select
		concat(beg_year, beg_month, beg_day) beg_date
		, sigungu_code
		, damage_cause
		, damage_result
		, com_dme::numeric com_dme
		from tb_year_dme_cause
		where sigungu_code
		is not null
		and concat(beg_year, beg_month, beg_day) <![CDATA[>=]]>
		#{beg_date} and concat(beg_year, beg_month, beg_day) <![CDATA[<=]]>
		#{end_date}
		<if test="law_code != null">
			and sigungu_code = #{law_code}
		</if>
		) rs
		group by beg_date, sigungu_code, damage_cause, damage_result
	</select>

	<select id="detailSummary" parameterType="hashMap" resultType="yearDmeDto">


		select 
			sum(com_dme) com_dme,
			sum(cnt) count,
			sum(pub_total) pub_total,
       		sum(pri_total) pri_total,
			(sum(pub_total)+sum(pri_total)) total_damage, 
			STRING_AGG(sido, ',') damage_sido
		from (
		select
		damage_code
		,sum(com_1::numeric + com_2::numeric) com_dme
		,sido_code
		,sido
		
		,count(*) cnt
		,(
		sum(pba_tot::numeric)
		+sum(pbb_tot::numeric)
		+sum(pbr_tot::numeric)
		+sum(pbc_tot::numeric)
		+sum(pbd_tot::numeric)
		+sum(pbf_tot::numeric)
		+sum(pbg_tot::numeric)
		+sum(pbh_tot::numeric)
		+sum(pbi_tot::numeric)
		+sum(pbj_tot::numeric)
		+sum(pbk_tot::numeric)
		+sum(pbl_tot::numeric)
		+sum(pbm_tot::numeric)
		+sum(pbn_tot::numeric)
		+sum(pbo_tot::numeric)
		) pub_total
		,(
		sum(pra_tot::numeric)
		+sum(prb_tot::numeric)
		+sum(prc_tot::numeric)
		+sum(prd_tot::numeric)
		+sum(pre_tot::numeric)
		+sum(prf_tot::numeric)
		+sum(prg_tot::numeric)
		+sum(etc_tot::numeric)
		) pri_total
		from
		tb_year_dme t1
		where concat(beg_year,beg_month,beg_day) <![CDATA[>=]]>
		#{beg_date} and concat(beg_year,beg_month,beg_day) <![CDATA[<=]]>
		#{end_date}
		<if test="damage_codes!=null">
			and damage_code in
			<foreach collection="damage_codes" item="item" open="("
				close=")" separator=",">
				#{item}
			</foreach>
		</if>
		<if test="damage_info != null">
		and damage_info like concat('%',#{damage_info}, '%')
		</if>
		group by damage_code,sido_code,sido
		) t1
	</select>

	
	<select id="listAllSigunguDamageAndRain" parameterType="hashMap" resultType="yearDmeDto" >
	with main as(
select
	law_code,
	stn_id,
	tm,
	rn_day,
	rn_10m_max,
	rn_60m_max
from
	(
	select
		substring(law_code, 1, 5) law_code ,
		stn_id ,
		tm ,
		law_area_per::numeric * (case when rn_day is null then 0 else rn_day / 10 end) rn_day ,
		law_area_per::numeric * (case when rn_60m_max is null then 0 else rn_10m_max / 10 end) rn_10m_max ,
		law_area_per::numeric * (case when rn_60m_max is null then 0 else rn_60m_max / 10 end) rn_60m_max
	from
		tb_obs_tsen asos
	left outer join tb_obs_asos tsen on
		asos.obs_id = tsen.stn_id::character varying
	where
		law_area in ('N','A')
		and tm <![CDATA[>=]]> #{beg_date}
		and tm <![CDATA[<=]]> #{end_date}
		and rn_day is not null ) t1
where
	rn_day <![CDATA[>]]> 0 ) select
	code sigungu_code,
	damage_code,
	beg_date,
	end_date,
	sum(com_dme::numeric) com_dem,
	sum(com_total) com_total,
	sum(pub_total) pub_total,
	sum(pri_total) pri_total,
	round(sum(sumRain), 1) rn_day,
	round(sum(maxHourRain), 1) rn_60m_max,
	round(sum(maxMinuteRain), 1) rn_10m_max
from
	(
	select
		t2.damage_code damage_code,
		t3.code,
		beg_date,
		end_date,
		(
			select sum(rn_day)
		from
			main
		where
			substring(law_code, 1, 5)= substring(code, 1, 5)
			and tm <![CDATA[>=]]> beg_date
			and tm <![CDATA[<=]]> end_date) sumRain,
		(
			select max(rn_60m_max)
		from
			main
		where
			substring(law_code, 1, 5)= substring(code, 1, 5)
			and tm <![CDATA[>=]]>  beg_date
			and tm <![CDATA[<=]]>  end_date) maxHourRain,
		(
			select max(rn_10m_max)
		from
			main
		where
			substring(law_code, 1, 5)= substring(code, 1, 5)
			and tm <![CDATA[>=]]>  beg_date
			and tm <![CDATA[<=]]>  end_date) maxMinuteRain,
		com_dme,
		com_total,
		pub_total,
		pri_total
	from
		(
		select
			damage_code ,
			sigungu_code ,
			concat(beg_year, beg_month, beg_day) beg_date ,
			concat(end_year, end_month, end_day) end_date ,
			( sum(com_1::numeric) + sum(com_2::numeric) ) com_dme ,
			( sum( cob_tot::numeric) + sum(cos_tot::numeric) + sum(cof_tot::numeric) + sum(cow_tot::numeric) ) com_total ,
			( sum(pba_tot::numeric) + sum(pbb_tot::numeric) + sum(pbr_tot::numeric) + sum(pbc_tot::numeric) + sum(pbd_tot::numeric) + sum(pbf_tot::numeric) + sum(pbg_tot::numeric) + sum(pbh_tot::numeric) + sum(pbi_tot::numeric) + sum(pbj_tot::numeric) + sum(pbk_tot::numeric) + sum(pbl_tot::numeric) + sum(pbm_tot::numeric) + sum(pbn_tot::numeric) + sum(pbo_tot::numeric) ) pub_total ,
			( sum(pra_tot::numeric) + sum(prb_tot::numeric) + sum(prc_tot::numeric) + sum(prd_tot::numeric) + sum(pre_tot::numeric) + sum(prf_tot::numeric) + sum(prg_tot::numeric) + sum(etc_tot::numeric) ) pri_total
		from
			tb_year_dme t1
		where
			concat(beg_year, beg_month, beg_day)<![CDATA[>=]]> #{beg_date}
			and concat(end_year, end_month, end_day) <![CDATA[<=]]> #{end_date}
		group by
			damage_code,
			sigungu_code,
			concat(beg_year, beg_month, beg_day),
			concat(end_year, end_month, end_day) ) t2
	left join tb_year_area_code t3 on
		t2.sigungu_code = t3.code
	where
		t3.code_level = '2' ) t4
where
	sumRain is not null
group by
	damage_code,
	code,
	beg_date,
	end_date
order by
	beg_date,
	end_date
	</select>
	
	<select id="listAllSidoDamageAndRain"  parameterType="hashMap" resultType="yearDmeDto" >
	with main as(
			select law_code,stn_id,tm,rn_day,rn_10m_max,rn_60m_max from (
			select 
			substring(law_code,1,5) law_code
			, stn_id
			, tm
			, law_area_per::numeric * (case when rn_day is null then 0 else rn_day / 10 end) rn_day
			, law_area_per::numeric * (case when rn_60m_max is null then 0 else rn_10m_max / 10 end) rn_10m_max
			, law_area_per::numeric * (case when rn_60m_max is null then 0 else rn_60m_max / 10 end) rn_60m_max
			from tb_obs_tsen asos 
			left outer join tb_obs_asos tsen on asos.obs_id = tsen.stn_id::character varying
			where law_area in ('Y')
			and tm  <![CDATA[>=]]> #{beg_date} and tm <![CDATA[<=]]> #{end_date}
			
			and rn_day is not null
			) t1
			where rn_day <![CDATA[>]]> 0
	)
	
	select 
	
	code sigungu_code,
	damage_code,
	beg_date,
	end_date,
	sum(com_dme::numeric) com_dem,
	sum(com_total) com_total,
	sum(pub_total) pub_total,
	sum(pri_total) pri_total,
	round(sum(sumRain),1) rn_day,
	round(sum(maxHourRain),1) rn_60m_max,
	round(sum(maxMinuteRain),1) rn_10m_max
	 from (	
	select 
	 t2.damage_code damage_code,
	 t3.code,
	 beg_date,
	 end_date,
	(select sum(rn_day) from main where substring(law_code,1,2)=substring(code,1,2) and tm <![CDATA[>=]]> beg_date and tm <![CDATA[<=]]> end_date) sumRain,
	(select max(rn_60m_max) from main where substring(law_code,1,2)=substring(code,1,2) and tm <![CDATA[>=]]> beg_date and tm <![CDATA[<=]]> end_date) maxHourRain,
	(select max(rn_10m_max) from main where substring(law_code,1,2)=substring(code,1,2) and tm <![CDATA[>=]]> beg_date and tm <![CDATA[<=]]> end_date) maxMinuteRain,
	com_dme,
	com_total,
	pub_total,
	pri_total 
	from 
	(
	select 
		
		damage_code
		,sigungu_code
		,concat(beg_year,beg_month,beg_day) beg_date
		,concat(end_year,end_month,end_day) end_date
		,( sum(com_1::numeric) + sum(com_2::numeric) ) com_dme
		,(
		sum( cob_tot::numeric)
		+sum(cos_tot::numeric)
		+sum(cof_tot::numeric)
		+sum(cow_tot::numeric)
		) com_total
		,( 
		sum(pba_tot::numeric)
		+sum(pbb_tot::numeric)
		+sum(pbr_tot::numeric)
		+sum(pbc_tot::numeric)
		+sum(pbd_tot::numeric)
		+sum(pbf_tot::numeric)
		+sum(pbg_tot::numeric)
		+sum(pbh_tot::numeric)
		+sum(pbi_tot::numeric)
		+sum(pbj_tot::numeric)
		+sum(pbk_tot::numeric)
		+sum(pbl_tot::numeric)
		+sum(pbm_tot::numeric)
		+sum(pbn_tot::numeric)
		+sum(pbo_tot::numeric)
		) pub_total
		,(
		sum(pra_tot::numeric)
		+sum(prb_tot::numeric)
		+sum(prc_tot::numeric)
		+sum(prd_tot::numeric)
		+sum(pre_tot::numeric)
		+sum(prf_tot::numeric)
		+sum(prg_tot::numeric)
		+sum(etc_tot::numeric)
		) pri_total
		from tb_year_dme t1  
		where
		 concat(beg_year,beg_month,beg_day)<![CDATA[>=]]> #{beg_date} and concat(end_year,end_month,end_day) <![CDATA[<=]]> #{end_date}
		group by damage_code,sigungu_code,concat(beg_year,beg_month,beg_day),concat(end_year,end_month,end_day)
		
	) t2
	left join tb_year_area_code t3 on  t2.sigungu_code=t3.code
	where t3.code_level='2'
	) t4
	where sumRain is not null
	group by damage_code, code, beg_date, end_date
	order by beg_date, end_date
	</select>
	
	<insert id="insertSummeryList" parameterType="yearDmeSummaryDto">
		INSERT INTO tb_year_dme_summary 
            (seq, 
             sigungu, 
             damage_code, 
             beg_date, 
             end_date, 
             person_dmage, 
             com_damage, 
             pri_damage, 
             public_damage, 
             rain_day, 
             rain_60, 
             rain_10, 
             sido_yn) 
		VALUES(
			 nextval('tb_year_dme_summary_seq'), 
             #{sigungu}, 
             #{damage_code}, 
             #{beg_date}, 
             #{end_date}, 
             #{person_dmage}, 
             #{com_damage}, 
             #{pri_damage}, 
             #{public_damage}, 
             #{rain_day}, 
             #{rain_60}, 
             #{rain_10}, 
             #{sido_yn}) 
	</insert>
	
	<select id="listTyphoonWithDamage" parameterType="hashMap" resultType="typhoonDamageDto">
		select 
		 rownum 
		,typ_name
		,typ_ps
		,typ_ws
		,typ_en
		,typ_sp
		,beg_date
		,typ_seq
		,tm_seq
		,end_date
		,com_dme
		,total_damage
		from tb_
	    where typ_name is not null
	    <if test="end_total_damage != null">
			and total_damage::numeric  <![CDATA[>=]]>#{st_total_damage} and total_damage::numeric <![CDATA[<=]]> #{end_total_damage}
		</if>
		<if test="end_com_dme != null">
			and com_dme::numeric  <![CDATA[ >=]]>#{st_com_dme} and com_dme::numeric  <![CDATA[ <= ]]>#{end_com_dme}
		</if>     
		order by end_date desc 
	</select>

</mapper>